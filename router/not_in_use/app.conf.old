map $http_upgrade $connection_upgrade { default upgrade; '' close; }

upstream frontend_upstream {
  server frontend:80;
}

upstream backend_upstream {
  server backend:8000 max_fails=3 fail_timeout=10s;
}

server {
  listen 80;
  server_name _;

  location = /healthz { return 200 "ok"; }

  include /etc/nginx/snippets/security-headers.conf;
  
  location /api/ {
    include /etc/nginx/snippets/proxy.conf;
    proxy_pass http://backend_upstream;
  }

  location / {
   include /etc/nginx/snippets/proxy.conf;
   proxy_pass http://frontend_upstream;
  }

}
